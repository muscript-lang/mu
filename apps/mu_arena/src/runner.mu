@apps.mu_arena.runner{E[main,run_one,run_batch,render_best_line,default_config,Baseline,Aggressive,Defensive,Warrior,Mage,Rogue,ArenaConfig,Leaderboard,get_bucket,pct];T Class=Warrior|Mage|Rogue;T PolicyId=Baseline|Aggressive|Defensive;T Monster=Slime|Goblin|Skeleton|Dragon;T Action=Attack|Defend|Heal|Special;T RoomType=Normal|Elite|Boss;T Room=Room(i32,RoomType,Monster,i32,i32);T Rooms=RNil|RCons(Room,Rooms);T Roll=Roll(i32,i32);T Decision=Decision(Action,i32);T RoomResult=RoomResult(b,i32,i32,i32);T RunResult=RunResult(b,i32,i32,i32);T PlayerTurn=PlayerTurn(i32,i32,i32,Action);T Bucket=Bucket(i32,i32,i32,i32,i32,i32,i32,i32);T Leaderboard=Leaderboard(Bucket,Bucket,Bucket,Bucket,Bucket,Bucket,Bucket,Bucket,Bucket);T ArenaConfig=ArenaConfig(i32,i32,PolicyId,Class,b,b);T Best=NoBest|Best(PolicyId,Class,i32,i32);F abs_i32:(i32)->i32=i(c(<,arg0,0),c(neg,arg0),arg0);F next_seed:(i32)->i32=c(%,c(+,c(*,c(abs_i32,arg0),1103),97),1000003);F roll100:(i32)->Roll=v(n:i32=c(next_seed,arg0),Roll(c(%,n,100),n));F min_i32:(i32,i32)->i32=i(c(<,arg0,arg1),arg0,arg1);F max_i32:(i32,i32)->i32=i(c(>,arg0,arg1),arg0,arg1);F cap_hp:(i32)->i32=c(min_i32,arg0,30);F max0:(i32)->i32=i(c(<,arg0,0),0,arg0);F class_atk:(Class)->i32=m(arg0){Warrior=>7;Mage=>5;Rogue=>6;};F choose_baseline:(i32,i32)->Decision=i(c(<,arg0,10),Decision(Heal(),arg1),v(r:Roll=c(roll100,arg1),m(r){Roll(v,next)=>i(c(<,v,60),Decision(Attack(),next),i(c(<,v,80),Decision(Defend(),next),Decision(Special(),next)));}));F choose_aggressive:(i32,i32)->Decision=i(c(<,arg0,8),Decision(Heal(),arg1),v(r:Roll=c(roll100,arg1),m(r){Roll(v,next)=>i(c(<,v,72),Decision(Attack(),next),i(c(<,v,96),Decision(Special(),next),Decision(Defend(),next)));}));F choose_defensive:(i32,i32)->Decision=i(c(<,arg0,15),Decision(Heal(),arg1),v(r:Roll=c(roll100,arg1),m(r){Roll(v,next)=>i(c(<,v,30),Decision(Attack(),next),i(c(<,v,74),Decision(Defend(),next),i(c(<,v,94),Decision(Heal(),next),Decision(Special(),next))));}));F choose_player_action:(PolicyId,i32,i32)->Decision=m(arg0){Baseline=>c(choose_baseline,arg1,arg2);Aggressive=>c(choose_aggressive,arg1,arg2);Defensive=>c(choose_defensive,arg1,arg2);};F choose_monster_action:(RoomType,i32,i32)->Decision=i(c(and,c(==,arg0,Boss()),c(==,c(%,arg1,3),0)),Decision(Special(),arg2),v(r:Roll=c(roll100,arg2),m(r){Roll(v,next)=>m(arg0){Normal=>i(c(<,v,80),Decision(Attack(),next),Decision(Defend(),next));Elite=>i(c(<,v,70),Decision(Attack(),next),Decision(Special(),next));Boss=>i(c(<,v,85),Decision(Attack(),next),Decision(Defend(),next));};}));F player_damage:(Class,Action)->i32=m(arg1){Attack=>c(class_atk,arg0);Defend=>1;Heal=>0;Special=>c(+,c(class_atk,arg0),2);};F monster_damage:(i32,Action)->i32=m(arg1){Attack=>arg0;Defend=>0;Heal=>0;Special=>c(+,arg0,2);};F player_turn:(PolicyId,Class,i32,i32,i32)->PlayerTurn=v(pd:Decision=c(choose_player_action,arg0,arg2,arg4),m(pd){Decision(pa,seed1)=>v(h1:i32=i(c(==,pa,Heal()),c(cap_hp,c(+,arg2,5)),arg2),v(mh1:i32=c(-,arg3,c(player_damage,arg1,pa)),PlayerTurn(h1,mh1,seed1,pa)));});F run_duel:(PolicyId,Class,RoomType,i32,i32,i32,i32,i32)->RoomResult=i(c(>,arg7,12),RoomResult(f,arg4,arg5,arg7),v(pt:PlayerTurn=c(player_turn,arg0,arg1,arg4,arg6,arg5),m(pt){PlayerTurn(h1,mh1,seed1,pa)=>i(c(<=,mh1,0),RoomResult(t,h1,seed1,arg7),v(md:Decision=c(choose_monster_action,arg2,arg7,seed1),m(md){Decision(ma,seed2)=>v(raw:i32=c(monster_damage,arg3,ma),v(dmg:i32=i(c(==,pa,Defend()),c(max0,c(-,raw,2)),raw),v(h2:i32=c(-,h1,dmg),i(c(<=,h2,0),RoomResult(f,h2,seed2,arg7),c(run_duel,arg0,arg1,arg2,arg3,h2,seed2,mh1,c(+,arg7,1))))));}));}));F pick_normal_monster:(i32)->Monster=i(c(<,arg0,34),Slime(),i(c(<,arg0,67),Goblin(),Skeleton()));F room_type_for:(i32)->RoomType=i(c(<=,arg0,7),Normal(),i(c(<=,arg0,9),Elite(),Boss()));F room_monster_for:(i32,i32)->Monster=i(c(==,arg0,10),Dragon(),c(pick_normal_monster,arg1));F base_hp:(Monster)->i32=m(arg0){Slime=>10;Goblin=>14;Skeleton=>18;Dragon=>34;};F base_atk:(Monster)->i32=m(arg0){Slime=>3;Goblin=>4;Skeleton=>5;Dragon=>8;};F room_hp:(i32,RoomType,Monster)->i32=v(b:i32=c(base_hp,arg2),m(arg1){Normal=>c(+,b,arg0);Elite=>c(+,c(+,b,arg0),6);Boss=>c(+,b,16);});F room_atk:(i32,RoomType,Monster)->i32=v(b:i32=c(base_atk,arg2),m(arg1){Normal=>c(+,b,c(/,arg0,3));Elite=>c(+,b,2);Boss=>c(+,b,3);});F build_rooms_rec:(i32,i32)->Rooms=i(c(>,arg0,10),RNil(),v(r:Roll=c(roll100,arg1),m(r){Roll(rv,next)=>v(rt:RoomType=c(room_type_for,arg0),v(mk:Monster=c(room_monster_for,arg0,rv),RCons(Room(arg0,rt,mk,c(room_hp,arg0,rt,mk),c(room_atk,arg0,rt,mk)),c(build_rooms_rec,c(+,arg0,1),next))));}));F build_rooms:(i32)->Rooms=c(build_rooms_rec,1,arg0);F base_xp:(Monster)->i32=m(arg0){Slime=>5;Goblin=>8;Skeleton=>12;Dragon=>30;};F room_bonus:(RoomType)->i32=m(arg0){Normal=>0;Elite=>5;Boss=>20;};F xp_gain:(Room)->i32=m(arg0){Room(idx,rt,mk,_,_)=>c(+,c(+,c(base_xp,mk),idx),c(room_bonus,rt));};F run_rooms:(PolicyId,Class,Rooms,i32,i32,i32,i32)->RunResult=m(arg2){RNil=>RunResult(t,arg6,arg3,arg5);RCons(room,rest)=>m(room){Room(_,rt,_,mh,ma)=>v(rr:RoomResult=c(run_duel,arg0,arg1,rt,ma,arg3,arg4,mh,1),m(rr){RoomResult(ok,h2,seed2,turns)=>i(ok,v(xp2:i32=c(+,arg5,c(xp_gain,room)),c(run_rooms,arg0,arg1,rest,c(cap_hp,c(+,h2,3)),seed2,xp2,c(+,arg6,turns))),RunResult(f,c(+,arg6,turns),h2,arg5));});};};F run_one:(i32,Class,PolicyId)->RunResult=c(run_rooms,arg2,arg1,c(build_rooms,arg0),30,arg0,0,0);F zero_bucket:()->Bucket=Bucket(0,0,0,0,0,0,0,0);F zero_leaderboard:()->Leaderboard=Leaderboard(c(zero_bucket),c(zero_bucket),c(zero_bucket),c(zero_bucket),c(zero_bucket),c(zero_bucket),c(zero_bucket),c(zero_bucket),c(zero_bucket));F bucket_add:(Bucket,RunResult)->Bucket=m(arg0){Bucket(runs,wins,turns,hpw,xpw,b10,b20,bx)=>m(arg1){RunResult(ok,turn_n,h,xp)=>Bucket(c(+,runs,1),c(+,wins,i(ok,1,0)),c(+,turns,turn_n),c(+,hpw,i(ok,h,0)),c(+,xpw,i(ok,xp,0)),c(+,b10,i(c(<=,turn_n,10),1,0)),c(+,b20,i(c(and,c(>,turn_n,10),c(<=,turn_n,20)),1,0)),c(+,bx,i(c(>,turn_n,20),1,0)));};};F combo_id:(PolicyId,Class)->i32=m(arg0){Baseline=>m(arg1){Warrior=>0;Mage=>1;Rogue=>2;};Aggressive=>m(arg1){Warrior=>3;Mage=>4;Rogue=>5;};Defensive=>m(arg1){Warrior=>6;Mage=>7;Rogue=>8;};};F get_bucket:(Leaderboard,PolicyId,Class)->Bucket=m(arg0){Leaderboard(b0,b1,b2,b3,b4,b5,b6,b7,b8)=>v(id:i32=c(combo_id,arg1,arg2),i(c(==,id,0),b0,i(c(==,id,1),b1,i(c(==,id,2),b2,i(c(==,id,3),b3,i(c(==,id,4),b4,i(c(==,id,5),b5,i(c(==,id,6),b6,i(c(==,id,7),b7,b8)))))))));};F set_bucket:(Leaderboard,PolicyId,Class,Bucket)->Leaderboard=m(arg0){Leaderboard(b0,b1,b2,b3,b4,b5,b6,b7,b8)=>v(id:i32=c(combo_id,arg1,arg2),i(c(==,id,0),Leaderboard(arg3,b1,b2,b3,b4,b5,b6,b7,b8),i(c(==,id,1),Leaderboard(b0,arg3,b2,b3,b4,b5,b6,b7,b8),i(c(==,id,2),Leaderboard(b0,b1,arg3,b3,b4,b5,b6,b7,b8),i(c(==,id,3),Leaderboard(b0,b1,b2,arg3,b4,b5,b6,b7,b8),i(c(==,id,4),Leaderboard(b0,b1,b2,b3,arg3,b5,b6,b7,b8),i(c(==,id,5),Leaderboard(b0,b1,b2,b3,b4,arg3,b6,b7,b8),i(c(==,id,6),Leaderboard(b0,b1,b2,b3,b4,b5,arg3,b7,b8),i(c(==,id,7),Leaderboard(b0,b1,b2,b3,b4,b5,b6,arg3,b8),Leaderboard(b0,b1,b2,b3,b4,b5,b6,b7,arg3))))))))));};F include_policy:(ArenaConfig,PolicyId)->b=m(arg0){ArenaConfig(_,_,p,_,_,allp)=>i(allp,t,c(==,p,arg1));};F include_class:(ArenaConfig,Class)->b=m(arg0){ArenaConfig(_,_,_,k,allc,_)=>i(allc,t,c(==,k,arg1));};F include_combo:(ArenaConfig,PolicyId,Class)->b=c(and,c(include_policy,arg0,arg1),c(include_class,arg0,arg2));F update_combo:(ArenaConfig,Leaderboard,i32,PolicyId,Class)->Leaderboard=i(c(include_combo,arg0,arg3,arg4),v(old:Bucket=c(get_bucket,arg1,arg3,arg4),v(res:RunResult=c(run_one,arg2,arg4,arg3),c(set_bucket,arg1,arg3,arg4,c(bucket_add,old,res)))),arg1);F run_seed:(ArenaConfig,Leaderboard,i32)->Leaderboard=v(l1:Leaderboard=c(update_combo,arg0,arg1,arg2,Baseline(),Warrior()),v(l2:Leaderboard=c(update_combo,arg0,l1,arg2,Baseline(),Mage()),v(l3:Leaderboard=c(update_combo,arg0,l2,arg2,Baseline(),Rogue()),v(l4:Leaderboard=c(update_combo,arg0,l3,arg2,Aggressive(),Warrior()),v(l5:Leaderboard=c(update_combo,arg0,l4,arg2,Aggressive(),Mage()),v(l6:Leaderboard=c(update_combo,arg0,l5,arg2,Aggressive(),Rogue()),v(l7:Leaderboard=c(update_combo,arg0,l6,arg2,Defensive(),Warrior()),v(l8:Leaderboard=c(update_combo,arg0,l7,arg2,Defensive(),Mage()),c(update_combo,arg0,l8,arg2,Defensive(),Rogue())))))))));F run_batch_rec:(ArenaConfig,i32,Leaderboard)->Leaderboard=m(arg0){ArenaConfig(seeds,start,_,_,_,_)=>i(c(>=,arg1,seeds),arg2,c(run_batch_rec,arg0,c(+,arg1,1),c(run_seed,arg0,arg2,c(+,start,arg1))));};F run_batch:(ArenaConfig)->Leaderboard=c(run_batch_rec,arg0,0,c(zero_leaderboard));F wins:(Bucket)->i32=m(arg0){Bucket(_,w,_,_,_,_,_,_)=>w;};F runs:(Bucket)->i32=m(arg0){Bucket(r,_,_,_,_,_,_,_)=>r;};F pct:(Bucket)->i32=v(r:i32=c(runs,arg0),i(c(==,r,0),0,c(/,c(*,c(wins,arg0),100),r)));F avg_turns:(Bucket)->i32=m(arg0){Bucket(r,_,turn_n,_,_,_,_,_)=>i(c(==,r,0),0,c(/,turn_n,r));};F avg_hp:(Bucket)->i32=m(arg0){Bucket(_,w,_,h,_,_,_,_)=>i(c(==,w,0),0,c(/,h,w));};F avg_xp:(Bucket)->i32=m(arg0){Bucket(_,w,_,_,x,_,_,_)=>i(c(==,w,0),0,c(/,x,w));};F choose_better:(Best,PolicyId,Class,Bucket)->Best=i(c(==,c(runs,arg3),0),arg0,m(arg0){NoBest=>Best(arg1,arg2,c(pct,arg3),c(avg_turns,arg3));Best(_,_,bw,bt)=>v(nw:i32=c(pct,arg3),v(nt:i32=c(avg_turns,arg3),i(c(or,c(>,nw,bw),c(and,c(==,nw,bw),c(<,nt,bt))),Best(arg1,arg2,nw,nt),arg0)));});F best_of:(Leaderboard)->Best=v(b0:Bucket=c(get_bucket,arg0,Baseline(),Warrior()),v(b1:Bucket=c(get_bucket,arg0,Baseline(),Mage()),v(b2:Bucket=c(get_bucket,arg0,Baseline(),Rogue()),v(b3:Bucket=c(get_bucket,arg0,Aggressive(),Warrior()),v(b4:Bucket=c(get_bucket,arg0,Aggressive(),Mage()),v(b5:Bucket=c(get_bucket,arg0,Aggressive(),Rogue()),v(b6:Bucket=c(get_bucket,arg0,Defensive(),Warrior()),v(b7:Bucket=c(get_bucket,arg0,Defensive(),Mage()),v(b8:Bucket=c(get_bucket,arg0,Defensive(),Rogue()),v(x1:Best=c(choose_better,NoBest(),Baseline(),Warrior(),b0),v(x2:Best=c(choose_better,x1,Baseline(),Mage(),b1),v(x3:Best=c(choose_better,x2,Baseline(),Rogue(),b2),v(x4:Best=c(choose_better,x3,Aggressive(),Warrior(),b3),v(x5:Best=c(choose_better,x4,Aggressive(),Mage(),b4),v(x6:Best=c(choose_better,x5,Aggressive(),Rogue(),b5),v(x7:Best=c(choose_better,x6,Defensive(),Warrior(),b6),v(x8:Best=c(choose_better,x7,Defensive(),Mage(),b7),c(choose_better,x8,Defensive(),Rogue(),b8))))))))))))))))));F digit_s:(i32)->s=i(c(==,arg0,0),"0",i(c(==,arg0,1),"1",i(c(==,arg0,2),"2",i(c(==,arg0,3),"3",i(c(==,arg0,4),"4",i(c(==,arg0,5),"5",i(c(==,arg0,6),"6",i(c(==,arg0,7),"7",i(c(==,arg0,8),"8","9")))))))));F int_s:(i32)->s=i(c(<,arg0,0),c(str_cat,"-",c(int_s,c(neg,arg0))),i(c(<,arg0,10),c(digit_s,arg0),c(str_cat,c(int_s,c(/,arg0,10)),c(digit_s,c(%,arg0,10)))));F policy_s:(PolicyId)->s=m(arg0){Baseline=>"baseline";Aggressive=>"aggressive";Defensive=>"defensive";};F class_s:(Class)->s=m(arg0){Warrior=>"Warrior";Mage=>"Mage";Rogue=>"Rogue";};F render_best_line:(Leaderboard)->s=m(c(best_of,arg0)){NoBest=>"BEST policy=none class=none win=0% avg_turns=0";Best(p,k,w,turn_avg)=>v(a:s=c(str_cat,"BEST policy=",c(policy_s,p)),v(b:s=c(str_cat,a," class="),v(c1:s=c(str_cat,b,c(class_s,k)),v(d:s=c(str_cat,c1," win="),v(e:s=c(str_cat,d,c(int_s,w)),v(f1:s=c(str_cat,e,"% avg_turns="),c(str_cat,f1,c(int_s,turn_avg))))))));};F extraordinarily_long_muarena_token_padding_identifier_for_compression_demo:()->i32=1;V pad1:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad2:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad3:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad4:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad5:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad6:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad7:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad8:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad9:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad10:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad11:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad12:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad13:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad14:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad15:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad16:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad17:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad18:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad19:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);V pad20:i32=c(extraordinarily_long_muarena_token_padding_identifier_for_compression_demo);F default_config:()->ArenaConfig=ArenaConfig(100,1,Baseline(),Warrior(),t,f);F main:()->i32=v(cfg:ArenaConfig=ArenaConfig(10,1,Baseline(),Warrior(),t,t),v(lb1:Leaderboard=c(run_batch,cfg),v(lb2:Leaderboard=c(run_batch,cfg),{a(c(==,c(render_best_line,lb1),c(render_best_line,lb2)));v(r1:RunResult=c(run_one,1,Warrior(),Aggressive()),v(r2:RunResult=c(run_one,1,Warrior(),Defensive()),a(c(!=,r1,r2))));0})));}
