@apps.mu_dungeon.main{:io=core.io;E[main];T Class=Warrior|Mage|Rogue;T Monster=Slime|Goblin|Skeleton|Dragon;T Status=None|Poison(i32)|Shield(i32);T Action=Attack|Defend|Heal|Special;T Event=Turn(i32)|PlayerAct(Action)|MonsterAct(Action)|DmgToPlayer(i32)|DmgToMonster(i32)|ApplyStatusToPlayer(Status)|ApplyStatusToMonster(Status)|PlayerDown|MonsterDown|EncounterWin|EncounterLose;T Outcome=Win(i32,i32)|Lose(i32);T RoomType=Normal|Elite|Boss;T Room=Room(i32,RoomType,Monster,i32,i32);T Rooms=RNil|RCons(Room,Rooms);T Events=VNil|VCons(Event,Events);T Roll=Roll(i32,i32);T Tick=Tick(i32,Status,Events);T Reduced=Reduced(i32,Status);T Apply=Apply(i32,Status,i32,Status,Events);T Decision=Decision(Action,i32);T RoomResult=RoomResult(i32,Status,i32,i32,Events,b);F abs_i32:(i32)->i32=i(c(<,arg0,0),c(neg,arg0),arg0);F next_seed:(i32)->i32=c(%,c(+,c(*,c(abs_i32,arg0),1103),97),1000003);F roll100:(i32)->Roll=v(n:i32=c(next_seed,arg0),Roll(c(%,n,100),n));F min_i32:(i32,i32)->i32=i(c(<,arg0,arg1),arg0,arg1);F cap_hp:(i32)->i32=c(min_i32,arg0,30);F class_atk:(Class)->i32=m(arg0){Warrior=>7;Mage=>5;Rogue=>6;};F add_shield:(Status,i32)->Status=m(arg0){Shield(v)=>Shield(c(min_i32,4,c(+,v,arg1)));_=>Shield(c(min_i32,4,arg1));};F reduce_with_shield:(i32,Status)->Reduced=m(arg1){Shield(v)=>i(c(<=,arg0,v),Reduced(0,None()),Reduced(c(-,arg0,v),None()));_=>Reduced(arg0,arg1);};F tick_poison:(b,i32,Status,Events)->Tick=m(arg2){Poison(v)=>v(h2:i32=c(-,arg1,v),v(s2:Status=i(c(<=,v,1),None(),Poison(c(-,v,1))),Tick(h2,s2,VCons(i(arg0,DmgToPlayer(v),DmgToMonster(v)),arg3))));_=>Tick(arg1,arg2,arg3);};F damage_target:(b,i32,i32,Status,Events)->Tick=v(r:Reduced=c(reduce_with_shield,arg1,arg3),m(r){Reduced(real,s2)=>Tick(c(-,arg2,real),s2,VCons(i(arg0,DmgToPlayer(real),DmgToMonster(real)),arg4));});F choose_player_action:(i32,i32)->Decision=i(c(<,arg0,10),Decision(Heal(),arg1),v(r:Roll=c(roll100,arg1),m(r){Roll(v,next)=>i(c(<,v,60),Decision(Attack(),next),i(c(<,v,80),Decision(Defend(),next),Decision(Special(),next)));}));F choose_monster_action:(RoomType,i32,i32)->Decision=i(c(and,c(==,arg0,Boss()),c(==,c(%,arg1,3),0)),Decision(Special(),arg2),v(r:Roll=c(roll100,arg2),m(r){Roll(v,next)=>m(arg0){Normal=>i(c(<,v,80),Decision(Attack(),next),Decision(Defend(),next));Elite=>i(c(<,v,70),Decision(Attack(),next),Decision(Special(),next));Boss=>i(c(<,v,85),Decision(Attack(),next),Decision(Defend(),next));};}));F apply_player_action:(Class,Action,i32,i32,Status,i32,Status,Events)->Apply=m(arg1){Attack=>v(tk:Tick=c(damage_target,f,arg2,arg5,arg6,arg7),m(tk){Tick(mh2,ms2,e2)=>Apply(arg3,arg4,mh2,ms2,VCons(PlayerAct(Attack()),e2));});Defend=>v(ps2:Status=c(add_shield,arg4,2),Apply(arg3,ps2,arg5,arg6,VCons(ApplyStatusToPlayer(ps2),VCons(PlayerAct(Defend()),arg7))));Heal=>Apply(c(cap_hp,c(+,arg3,5)),arg4,arg5,arg6,VCons(PlayerAct(Heal()),arg7));Special=>m(arg0){Warrior=>v(tk:Tick=c(damage_target,f,c(+,arg2,3),arg5,arg6,arg7),m(tk){Tick(mh2,ms2,e2)=>Apply(c(-,arg3,1),arg4,mh2,ms2,VCons(DmgToPlayer(1),VCons(PlayerAct(Special()),e2)));});Mage=>v(ms2:Status=Poison(2),Apply(arg3,arg4,arg5,ms2,VCons(ApplyStatusToMonster(ms2),VCons(PlayerAct(Special()),arg7))));Rogue=>v(ps2:Status=c(add_shield,arg4,3),Apply(arg3,ps2,arg5,arg6,VCons(ApplyStatusToPlayer(ps2),VCons(PlayerAct(Special()),arg7))));};};F apply_monster_action:(RoomType,Action,i32,i32,Status,i32,Status,Events)->Apply=m(arg1){Attack=>v(tk:Tick=c(damage_target,t,arg2,arg3,arg4,arg7),m(tk){Tick(ph2,ps2,e2)=>Apply(ph2,ps2,arg5,arg6,VCons(MonsterAct(Attack()),e2));});Defend=>v(ms2:Status=c(add_shield,arg6,2),Apply(arg3,arg4,arg5,ms2,VCons(ApplyStatusToMonster(ms2),VCons(MonsterAct(Defend()),arg7))));Heal=>Apply(arg3,arg4,arg5,arg6,VCons(MonsterAct(Heal()),arg7));Special=>m(arg0){Elite=>v(t1:Tick=c(damage_target,t,arg2,arg3,arg4,arg7),m(t1){Tick(ph2,ps2,e1)=>v(ps3:Status=Poison(1),Apply(ph2,ps3,arg5,arg6,VCons(ApplyStatusToPlayer(ps3),VCons(MonsterAct(Special()),e1))));});Boss=>v(t2:Tick=c(damage_target,t,c(+,arg2,2),arg3,arg4,arg7),m(t2){Tick(ph2,ps2,e2)=>v(ps3:Status=Poison(2),Apply(ph2,ps3,arg5,arg6,VCons(ApplyStatusToPlayer(ps3),VCons(MonsterAct(Special()),e2))));});Normal=>v(t3:Tick=c(damage_target,t,arg2,arg3,arg4,arg7),m(t3){Tick(ph2,ps2,e3)=>Apply(ph2,ps2,arg5,arg6,VCons(MonsterAct(Attack()),e3));});};};F rev_events_acc:(Events,Events)->Events=m(arg0){VNil=>arg1;VCons(h,rest)=>c(rev_events_acc,rest,VCons(h,arg1));};F rev_events:(Events)->Events=c(rev_events_acc,arg0,VNil());F win_result:(i32,Status,i32,i32,Events)->RoomResult=RoomResult(arg0,arg1,arg2,arg3,VCons(EncounterWin(),VCons(MonsterDown(),arg4)),t);F lose_result:(i32,Status,i32,i32,Events)->RoomResult=RoomResult(arg0,arg1,arg2,arg3,VCons(EncounterLose(),VCons(PlayerDown(),arg4)),f);F run_after_monster_tick:(Class,RoomType,i32,i32,i32,Status,i32,Status,i32,i32,i32,Events)->RoomResult=v(md:Decision=c(choose_monster_action,arg1,arg10,arg8),m(md){Decision(ma,seed2)=>v(am:Apply=c(apply_monster_action,arg1,ma,arg3,arg4,arg5,arg6,arg7,arg11),m(am){Apply(ph3,ps3,mh4,ms4,e4)=>i(c(<=,ph3,0),c(lose_result,ph3,ps3,seed2,arg9,e4),c(run_turn,arg0,arg1,arg2,arg3,ph3,ps3,mh4,ms4,seed2,c(+,arg9,1),c(+,arg10,1),e4));});});F run_after_player_action:(Class,RoomType,i32,i32,i32,Status,i32,Status,i32,i32,i32,Events)->RoomResult=v(tm:Tick=c(tick_poison,f,arg6,arg7,arg11),m(tm){Tick(mh3,ms3,e3)=>i(c(<=,mh3,0),c(win_result,arg4,arg5,arg8,arg9,e3),c(run_after_monster_tick,arg0,arg1,arg2,arg3,arg4,arg5,mh3,ms3,arg8,arg9,arg10,e3));});F run_after_player_tick:(Class,RoomType,i32,i32,i32,Status,i32,Status,i32,i32,i32,Events)->RoomResult=v(pd:Decision=c(choose_player_action,arg4,arg8),m(pd){Decision(pa,seed1)=>v(ap:Apply=c(apply_player_action,arg0,pa,arg2,arg4,arg5,arg6,arg7,arg11),m(ap){Apply(ph2,ps2,mh2,ms2,e2)=>i(c(<=,mh2,0),c(win_result,ph2,ps2,seed1,arg9,e2),c(run_after_player_action,arg0,arg1,arg2,arg3,ph2,ps2,mh2,ms2,seed1,arg9,arg10,e2));});});F run_turn:(Class,RoomType,i32,i32,i32,Status,i32,Status,i32,i32,i32,Events)->RoomResult=v(e0:Events=VCons(Turn(arg9),arg11),v(tp:Tick=c(tick_poison,t,arg4,arg5,e0),m(tp){Tick(ph1,ps1,e1)=>i(c(<=,ph1,0),c(lose_result,ph1,ps1,arg8,arg9,e1),c(run_after_player_tick,arg0,arg1,arg2,arg3,ph1,ps1,arg6,arg7,arg8,arg9,arg10,e1));}));F run_room:(Class,Room,i32,Status,i32)->RoomResult=m(arg1){Room(_,rt,_,mh,ma)=>v(raw:RoomResult=c(run_turn,arg0,rt,c(class_atk,arg0),ma,arg2,arg3,mh,None(),arg4,1,1,VNil()),m(raw){RoomResult(ph,ps,next,turns,evs,ok)=>RoomResult(ph,ps,next,turns,c(rev_events,evs),ok);});};F pick_class:(i32)->Class=v(k:i32=c(%,c(abs_i32,arg0),3),i(c(==,k,0),Warrior(),i(c(==,k,1),Mage(),Rogue())));F pick_normal_monster:(i32)->Monster=i(c(<,arg0,34),Slime(),i(c(<,arg0,67),Goblin(),Skeleton()));F room_type_for:(i32)->RoomType=i(c(<=,arg0,7),Normal(),i(c(<=,arg0,9),Elite(),Boss()));F room_monster_for:(i32,i32)->Monster=i(c(==,arg0,10),Dragon(),c(pick_normal_monster,arg1));F base_hp:(Monster)->i32=m(arg0){Slime=>10;Goblin=>14;Skeleton=>18;Dragon=>34;};F base_atk:(Monster)->i32=m(arg0){Slime=>3;Goblin=>4;Skeleton=>5;Dragon=>8;};F room_hp:(i32,RoomType,Monster)->i32=v(b:i32=c(base_hp,arg2),m(arg1){Normal=>c(+,b,arg0);Elite=>c(+,c(+,b,arg0),6);Boss=>c(+,b,16);});F room_atk:(i32,RoomType,Monster)->i32=v(b:i32=c(base_atk,arg2),m(arg1){Normal=>c(+,b,c(/,arg0,3));Elite=>c(+,b,2);Boss=>c(+,b,3);});F build_rooms_rec:(i32,i32)->Rooms=i(c(>,arg0,10),RNil(),v(r:Roll=c(roll100,arg1),m(r){Roll(rv,next)=>v(rt:RoomType=c(room_type_for,arg0),v(mk:Monster=c(room_monster_for,arg0,rv),RCons(Room(arg0,rt,mk,c(room_hp,arg0,rt,mk),c(room_atk,arg0,rt,mk)),c(build_rooms_rec,c(+,arg0,1),next))));}));F build_rooms:(i32)->Rooms=c(build_rooms_rec,1,arg0);F base_xp:(Monster)->i32=m(arg0){Slime=>5;Goblin=>8;Skeleton=>12;Dragon=>30;};F room_bonus:(RoomType)->i32=m(arg0){Normal=>0;Elite=>5;Boss=>20;};F xp_gain:(Room)->i32=m(arg0){Room(idx,rt,mk,_,_)=>c(+,c(+,c(base_xp,mk),idx),c(room_bonus,rt));};F digit_s:(i32)->s=i(c(==,arg0,0),"0",i(c(==,arg0,1),"1",i(c(==,arg0,2),"2",i(c(==,arg0,3),"3",i(c(==,arg0,4),"4",i(c(==,arg0,5),"5",i(c(==,arg0,6),"6",i(c(==,arg0,7),"7",i(c(==,arg0,8),"8","9")))))))));F int_s:(i32)->s=i(c(<,arg0,0),c(str_cat,"-",c(int_s,c(neg,arg0))),i(c(<,arg0,10),c(digit_s,arg0),i(c(<,arg0,100),c(str_cat,c(digit_s,c(/,arg0,10)),c(digit_s,c(%,arg0,10))),c(str_cat,c(str_cat,c(digit_s,c(/,arg0,100)),c(digit_s,c(%,c(/,arg0,10),10))),c(digit_s,c(%,arg0,10))))));F action_s:(Action)->s=m(arg0){Attack=>"Attack";Defend=>"Defend";Heal=>"Heal";Special=>"Special";};F status_s:(Status)->s=m(arg0){None=>"None";Poison(v)=>c(str_cat,"Poison",c(int_s,v));Shield(v)=>c(str_cat,"Shield",c(int_s,v));};F render_event:(i32,Event)->s=m(arg1){Turn(turn_n)=>c(str_cat,c(str_cat,c(str_cat,"R",c(int_s,arg0))," T"),c(int_s,turn_n));PlayerAct(a1)=>c(str_cat,c(str_cat,c(str_cat,"R",c(int_s,arg0))," P:"),c(action_s,a1));MonsterAct(a2)=>c(str_cat,c(str_cat,c(str_cat,"R",c(int_s,arg0))," M:"),c(action_s,a2));DmgToPlayer(v)=>c(str_cat,c(str_cat,c(str_cat,"R",c(int_s,arg0))," Dp:"),c(int_s,v));DmgToMonster(v)=>c(str_cat,c(str_cat,c(str_cat,"R",c(int_s,arg0))," Dm:"),c(int_s,v));ApplyStatusToPlayer(s1)=>c(str_cat,c(str_cat,c(str_cat,"R",c(int_s,arg0))," SP:"),c(status_s,s1));ApplyStatusToMonster(s2)=>c(str_cat,c(str_cat,c(str_cat,"R",c(int_s,arg0))," SM:"),c(status_s,s2));PlayerDown=>c(str_cat,c(str_cat,"R",c(int_s,arg0))," PlayerDown");MonsterDown=>c(str_cat,c(str_cat,"R",c(int_s,arg0))," MonsterDown");EncounterWin=>c(str_cat,c(str_cat,"R",c(int_s,arg0))," EncounterWin");EncounterLose=>c(str_cat,c(str_cat,"R",c(int_s,arg0))," EncounterLose");};F print_events:(i32,Events)->i32!{io}=m(arg1){VNil=>0;VCons(h,rest)=>{c(println,c(render_event,arg0,h));c(print_events,arg0,rest)};};F win_result_line:(i32,i32,i32,i32)->s=c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,"RESULT Win xp=",c(int_s,arg0))," hp="),c(int_s,arg1))," rooms="),c(int_s,arg2))," seed="),c(int_s,arg3)),"");F lose_result_line:(i32,i32,i32,i32,i32)->s=c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,"RESULT Lose room=",c(int_s,arg0))," turn="),c(int_s,arg1))," xp="),c(int_s,arg2))," hp="),c(int_s,arg3))," seed="),c(int_s,arg4)),"");F room_clear_line:(i32,i32,i32)->s=c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,c(str_cat,"ROOM_CLEAR R",c(int_s,arg0))," xp="),c(int_s,arg1))," turns="),c(int_s,arg2)),"");F run_rooms_io:(Class,Rooms,i32,Status,i32,i32,i32)->i32!{io}=m(arg1){RNil=>{c(println,c(win_result_line,arg5,arg2,arg6,1));0};RCons(room,rest)=>m(room){Room(idx,_,_,_,_)=>v(rr:RoomResult=c(run_room,arg0,room,arg2,arg3,arg4),m(rr){RoomResult(ph,ps,next,turns,evs,ok)=>{c(print_events,idx,evs);i(ok,v(gain:i32=c(xp_gain,room),v(xp2:i32=c(+,arg5,gain),{c(println,c(room_clear_line,idx,xp2,turns));c(run_rooms_io,arg0,rest,c(cap_hp,c(+,ph,3)),None(),next,xp2,c(+,arg6,1))})),{c(println,c(lose_result_line,idx,turns,arg5,ph,next));0})};});};};F main:()->i32!{io}=v(seed:i32=1,v(klass:Class=c(pick_class,seed),c(run_rooms_io,klass,c(build_rooms,seed),30,None(),seed,0,0)));}
