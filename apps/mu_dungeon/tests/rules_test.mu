@apps.mu_dungeon.tests.rules_test{E[main];T Class=Warrior|Mage|Rogue;T Monster=Slime|Goblin|Skeleton|Dragon;T Status=None|Poison(i32)|Shield(i32);T Action=Attack|Defend|Heal|Special;T RoomType=Normal|Elite|Boss;T Event=Turn(i32)|PlayerAct(Action)|MonsterAct(Action)|DmgToPlayer(i32)|DmgToMonster(i32)|ApplyStatusToPlayer(Status)|ApplyStatusToMonster(Status)|PlayerDown|MonsterDown|EncounterWin|EncounterLose;T Events=VNil|VCons(Event,Events);T Reduced=Reduced(i32,Status);T Tick=Tick(i32,Status,Events);T Apply=Apply(i32,Status,i32,Status,Events);T Decision=Decision(Action,i32);F min_i32:(i32,i32)->i32=i(c(<,arg0,arg1),arg0,arg1);F add_shield:(Status,i32)->Status=m(arg0){Shield(v)=>Shield(c(min_i32,4,c(+,v,arg1)));_=>Shield(c(min_i32,4,arg1));};F reduce_with_shield:(i32,Status)->Reduced=m(arg1){Shield(v)=>i(c(<=,arg0,v),Reduced(0,None()),Reduced(c(-,arg0,v),None()));_=>Reduced(arg0,arg1);};F damage_target:(b,i32,i32,Status,Events)->Tick=v(r:Reduced=c(reduce_with_shield,arg1,arg3),m(r){Reduced(real,s2)=>Tick(c(-,arg2,real),s2,VCons(i(arg0,DmgToPlayer(real),DmgToMonster(real)),arg4));});F tick_poison:(b,i32,Status,Events)->Tick=m(arg2){Poison(v)=>Tick(c(-,arg1,v),i(c(<=,v,1),None(),Poison(c(-,v,1))),VCons(i(arg0,DmgToPlayer(v),DmgToMonster(v)),arg3));_=>Tick(arg1,arg2,arg3);};F choose_monster_action:(RoomType,i32,i32)->Decision=i(c(and,c(==,arg0,Boss()),c(==,c(%,arg1,3),0)),Decision(Special(),arg2),Decision(Attack(),arg2));F main:()->i32={v(t1:Tick=c(damage_target,t,8,20,Shield(2),VNil()),m(t1){Tick(h,s,_)=>{a(c(==,h,14));a(c(==,s,None()));0};});v(t2:Tick=c(tick_poison,t,10,Poison(1),VNil()),m(t2){Tick(h,s,_)=>{a(c(==,h,9));a(c(==,s,None()));0};});v(d:Decision=c(choose_monster_action,Boss(),3,12),m(d){Decision(act,_)=>a(c(==,act,Special()));});a(c(==,c(add_shield,Shield(3),2),Shield(4)));0};}
