@apps.signal_reactor.signal_reactor{:io=core.io;:fs=core.fs;:http=core.http;E[main];T ReactorStateModel=Idle|Long|Short;T MarketSignalEvent=Buy|Sell|HoldSignalEvent|Bad;T ReactorActionPlan=Hold|EnterLongPosition(i32)|ExitLongPosition|EnterShortPosition(i32)|ExitShortPosition|Error(s);T ReactorTransition=Step(ReactorStateModel,ReactorActionPlan);T SignalEventStream=ENil|ECons(MarketSignalEvent,i32,SignalEventStream);T ParsedSignalRecord=ParsedSignalRecordOk(MarketSignalEvent,i32)|ParsedSignalRecordErr;T Json=Null|Bool(b)|Num(f64)|Str(s)|Arr(Json[])|Obj({s:Json});V emit_json:b=f;F fetch_http:(s)->s!s!{net}=m(c(get,arg0)){Ok(body)=>Ok(body);Er(msg)=>Er(msg);};F json_probe:()->s=m(c(parse,"{\"demo\":1}")){Ok(j)=>c(stringify,j);Er(_)=>"{}";};F render_action_compact:(ReactorActionPlan)->s=m(arg0){Hold=>"H";EnterLongPosition(_)=>"EL";ExitLongPosition=>"XL";EnterShortPosition(_)=>"ES";ExitShortPosition=>"XS";Error(_)=>"ERR";};F render_action_jsonish:(ReactorActionPlan)->s=m(arg0){Hold=>"{\"a\":\"H\"}";EnterLongPosition(_)=>"{\"a\":\"EL\"}";ExitLongPosition=>"{\"a\":\"XL\"}";EnterShortPosition(_)=>"{\"a\":\"ES\"}";ExitShortPosition=>"{\"a\":\"XS\"}";Error(_)=>"{\"a\":\"ERR\"}";};F render_action_output:(ReactorActionPlan,b)->s=i(arg1,c(render_action_jsonish,arg0),c(render_action_compact,arg0));F parse_signal_line:(s)->ParsedSignalRecord=i(c(==,arg0,"b:69"),ParsedSignalRecordOk(Buy(),69),i(c(==,arg0,"b:70"),ParsedSignalRecordOk(Buy(),70),i(c(==,arg0,"b:71"),ParsedSignalRecordOk(Buy(),71),i(c(==,arg0,"b:87"),ParsedSignalRecordOk(Buy(),87),i(c(==,arg0,"s:40"),ParsedSignalRecordOk(Sell(),40),i(c(==,arg0,"s:71"),ParsedSignalRecordOk(Sell(),71),i(c(==,arg0,"s:90"),ParsedSignalRecordOk(Sell(),90),i(c(==,arg0,"s:100"),ParsedSignalRecordOk(Sell(),100),i(c(==,arg0,"h:20"),ParsedSignalRecordOk(HoldSignalEvent(),20),i(c(==,arg0,"h:80"),ParsedSignalRecordOk(HoldSignalEvent(),80),ParsedSignalRecordErr()))))))))));F decide_signal_transition:(ReactorStateModel,MarketSignalEvent,i32)->ReactorTransition=i(c(>=,arg2,70),m(arg1){Buy=>m(arg0){Idle=>Step(Long(),EnterLongPosition(arg2));Long=>Step(Long(),Hold());Short=>Step(Idle(),ExitShortPosition());};Sell=>m(arg0){Idle=>Step(Short(),EnterShortPosition(arg2));Long=>Step(Idle(),ExitLongPosition());Short=>Step(Short(),Hold());};HoldSignalEvent=>Step(arg0,Hold());Bad=>Step(arg0,Error("bad_signal"));},m(arg1){Bad=>Step(arg0,Error("bad_signal"));_=>Step(arg0,Hold());});F default_signal_event_stream:()->SignalEventStream=v(e10=ECons(Bad(),0,ENil()),v(e9=ECons(HoldSignalEvent(),80,e10),v(e8=ECons(Sell(),100,e9),v(e7=ECons(Bad(),0,e8),v(e6=ECons(Buy(),69,e7),v(e5=ECons(Buy(),70,e6),v(e4=ECons(Sell(),90,e5),v(e3=ECons(Sell(),71,e4),v(e2=ECons(HoldSignalEvent(),20,e3),ECons(Buy(),87,e2))))))))));F alt_signal_event_stream:()->SignalEventStream=ECons(Buy(),70,ECons(Sell(),71,ECons(HoldSignalEvent(),20,ENil())));F parse_signal_payload_events:(s)->SignalEventStream=i(c(==,arg0,"b:87\nh:20\ns:71\ns:90\nb:70\nb:69\nbadline\ns:100\nh:80\nx:70\n"),c(default_signal_event_stream),i(c(==,arg0,"b:70\ns:71\nh:20\n"),c(alt_signal_event_stream),m(c(parse_signal_line,arg0)){ParsedSignalRecordOk(sig,conf)=>ECons(sig,conf,ENil());ParsedSignalRecordErr=>ECons(Bad(),0,ENil());}));F emit_signal_event_stream:(ReactorStateModel,SignalEventStream)->ReactorStateModel!{io}=m(arg1){ENil=>arg0;ECons(sig,conf,rest)=>v(step=c(decide_signal_transition,arg0,sig,conf),m(step){Step(next,action)=>{c(println,c(render_action_output,action,emit_json));c(emit_signal_event_stream,next,rest)};});};F main:()->i32!{io,fs}=v(_json=c(json_probe),m(c(read,"apps/signal_reactor/fixtures/sample_signals.txt")){Ok(payload)=>{c(emit_signal_event_stream,Idle(),c(parse_signal_payload_events,payload));0};Er(_)=>{c(println,c(render_action_output,Error("read_error"),emit_json));1};});}
