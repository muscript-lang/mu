@apps.signal_reactor.signal_reactor{:io=core.io;:fs=core.fs;:http=core.http;E[main];T State=Idle|Long|Short;T Signal=Buy|Sell|HoldSig|Bad;T Action=Hold|EnterLong(i32)|ExitLong|EnterShort(i32)|ExitShort|Error(s);T Decision=Step(State,Action);T Events=ENil|ECons(Signal,i32,Events);T Parsed=ParsedOk(Signal,i32)|ParsedErr;T Json=Null|Bool(b)|Num(f64)|Str(s)|Arr(Json[])|Obj({s:Json});F fetch_http:(s)->s!s!{net}=m(c(get,arg0)){Ok(body)=>Ok(body);Er(msg)=>Er(msg);};F json_probe:()->s=m(c(parse,"{\"demo\":1}")){Ok(j)=>c(stringify,j);Er(_)=>"{}";};F action_json:(Action)->s=m(arg0){Hold=>"{\"a\":\"H\"}";EnterLong(_)=>"{\"a\":\"EL\"}";ExitLong=>"{\"a\":\"XL\"}";EnterShort(_)=>"{\"a\":\"ES\"}";ExitShort=>"{\"a\":\"XS\"}";Error(_)=>"{\"a\":\"ERR\"}";};F parse_line:(s)->Parsed=i(c(==,arg0,"b:69"),ParsedOk(Buy(),69),i(c(==,arg0,"b:70"),ParsedOk(Buy(),70),i(c(==,arg0,"b:71"),ParsedOk(Buy(),71),i(c(==,arg0,"b:87"),ParsedOk(Buy(),87),i(c(==,arg0,"s:40"),ParsedOk(Sell(),40),i(c(==,arg0,"s:71"),ParsedOk(Sell(),71),i(c(==,arg0,"s:90"),ParsedOk(Sell(),90),i(c(==,arg0,"s:100"),ParsedOk(Sell(),100),i(c(==,arg0,"h:20"),ParsedOk(HoldSig(),20),i(c(==,arg0,"h:80"),ParsedOk(HoldSig(),80),ParsedErr()))))))))));F decide:(State,Signal,i32)->Decision=i(c(>=,arg2,70),m(arg1){Buy=>m(arg0){Idle=>Step(Long(),EnterLong(arg2));Long=>Step(Long(),Hold());Short=>Step(Idle(),ExitShort());};Sell=>m(arg0){Idle=>Step(Short(),EnterShort(arg2));Long=>Step(Idle(),ExitLong());Short=>Step(Short(),Hold());};HoldSig=>Step(arg0,Hold());Bad=>Step(arg0,Error("bad_signal"));},m(arg1){Bad=>Step(arg0,Error("bad_signal"));_=>Step(arg0,Hold());});F default_events:()->Events=v(e10:Events=ECons(Bad(),0,ENil()),v(e9:Events=ECons(HoldSig(),80,e10),v(e8:Events=ECons(Sell(),100,e9),v(e7:Events=ECons(Bad(),0,e8),v(e6:Events=ECons(Buy(),69,e7),v(e5:Events=ECons(Buy(),70,e6),v(e4:Events=ECons(Sell(),90,e5),v(e3:Events=ECons(Sell(),71,e4),v(e2:Events=ECons(HoldSig(),20,e3),ECons(Buy(),87,e2))))))))));F alt_events:()->Events=ECons(Buy(),70,ECons(Sell(),71,ECons(HoldSig(),20,ENil())));F parse_payload:(s)->Events=i(c(==,arg0,"b:87\nh:20\ns:71\ns:90\nb:70\nb:69\nbadline\ns:100\nh:80\nx:70\n"),c(default_events),i(c(==,arg0,"b:70\ns:71\nh:20\n"),c(alt_events),m(c(parse_line,arg0)){ParsedOk(sig,conf)=>ECons(sig,conf,ENil());ParsedErr=>ECons(Bad(),0,ENil());}));F emit_events:(State,Events)->State!{io}=m(arg1){ENil=>arg0;ECons(sig,conf,rest)=>v(step:Decision=c(decide,arg0,sig,conf),m(step){Step(next,action)=>{c(println,c(action_json,action));c(emit_events,next,rest)};});};F main:()->i32!{io,fs}=v(_json:s=c(json_probe),m(c(read,"apps/signal_reactor/fixtures/sample_signals.txt")){Ok(payload)=>{c(emit_events,Idle(),c(parse_payload,payload));0};Er(_)=>{c(println,"{\"a\":\"ERR\"}");1};});}
